---
- name: Deploy GitLab
  hosts: gitlab
  vars:
    hostname: gitlab
  tasks:

  - name: List all hosted zones
    amazon.aws.route53_info:
      query: hosted_zone
    register: r53
    delegate_to: localhost

  - name: debug
    ansible.builtin.debug:
      msg: "{{ r53.HostedZones}}"
  - name: debug
    ansible.builtin.debug:
      msg: "{{ r53.HostedZones[0] }}"

  - name: debug
    ansible.builtin.debug:
      msg: "{{ r53.HostedZones[0].Name }}"

  - name: Set hostname
    ansible.builtin.set_fact:
      zone: "{{ r53.HostedZones[0].Name }}"

  - name: Configure certificates
    ansible.builtin.include_role:       
      name: "demo.cloud.certbot53"
    vars:
      acme_env: staging

  - name: Configure certificates
    ansible.builtin.include_role:       
      name: "demo.cloud.certbot53"
    vars:
      acme_env: production
      acme_directory: "https://acme-v02.api.letsencrypt.org/directory"

  - name: Configure GitLab
    ansible.builtin.include_role:       
      name: "demo.cloud.gitlab"

